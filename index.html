<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Checkfast Lista Digitale</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
  .logoBox{
    width:100%;
    text-align:center;
    margin-bottom:15px;
  }
  .logoImg{
    max-width:150px;
    height:auto;
    filter:brightness(1);
  }

  body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    background:#2b384b;
    color:#fff;
    margin:0;
    padding:15px
  }
  h1{
    text-align:center;
    font-size:22px;
    margin-bottom:20px
  }
  .card{
    background:#1f2937;
    border-radius:10px;
    padding:15px;
    margin-bottom:15px
  }
  #searchBox{
    padding:12px;
    border-radius:8px;
    border:none;
    width:70%;
    margin:6px auto;
    display:block;
    font-size:18px
  }
  table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px
  }
  th,td{
    padding:10px;
    border-bottom:1px solid #374151;
    font-size:16px
  }
  th{
    background:#111827;
    position:sticky;
    top:0;
    z-index:2;
    text-align:left
  }
  tr:nth-child(even){background:#111827}
  tr:nth-child(odd){background:#020617}
  tr.confirmed{
    background:#4CAF50!important;
    color:#fff
  }
  tr.selected{
    background:#2563eb!important;
    color:#fff
  }
  button{
    padding:12px 14px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    margin:6px;
    font-size:16px
  }
  button.primary{background:#e52013;color:#fff}
  button.ok{background:#16a34a;color:#fff}
  .counter{
    margin-top:10px;
    font-size:20px;
    text-align:center
  }
  .hidden{display:none}
  .popupConfirm{
    position:fixed;
    top:15%;
    left:50%;
    transform:translateX(-50%);
    background:#16a34a;
    color:#fff;
    padding:20px 40px;
    border-radius:999px;
    font-size:25px;
    display:none;
    z-index:999;
    box-shadow:0 6px 20px rgba(0,0,0,0.6);
    animation:pop .3s ease-out
  }
  @keyframes pop{
    from{transform:translateX(-50%) scale(.9);opacity:0}
    to{transform:translateX(-50%) scale(1);opacity:1}
  }
  .actionsBottom{
    text-align:center;
    margin-top:30px
  }
  .actionsBottom button{
    min-width:140px;
    margin:8px;
    font-size:16px;
    color:#fff
  }
  #showListBtn{background:#2563eb}
  #reportBtn{background:#d97706}
  #registerNewBtn{background:#16a34a}
  </style>
</head>
<body>
  <div class="logoBox">
    <img src="https://static.wixstatic.com/media/2080b2_091288fac9ef49fb875e82a42f827415~mv2.png" alt="Logo" class="logoImg">
  </div>
  <h1>EVENTO TEATRO ALCIONE - 9 Dicembre 2025</h1>
  
  <div class="card hidden" id="toolsCard">
    <input type="text" id="searchBox" placeholder="Cerca ospite" autofocus>
    <div class="counter"><span id="countChecked">0</span> / <span id="countTotal">0</span></div>
  </div>

  <div class="card hidden" id="tableCard">
    <table id="dataTable">
      <thead><tr><th>Ospite</th><th>Tavolo</th><th>Note</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="card hidden" id="confirmCard">
    <button id="confirmBtn" class="ok" style="width:100%;">CONFERMA</button>
  </div>

  <div class="actionsBottom hidden" id="exportCard">
    <button id="showListBtn">Mostra/Nascondi</button>
    <button id="reportBtn">Report</button>
    <button id="registerNewBtn">Registra nuovo ospite</button>
  </div>

  <div class="popupConfirm" id="popupConfirm">Ospite Accreditato</div>

  <script>
/* ===== URL WEB APP GOOGLE APPS SCRIPT ===== */
const sheetURL = "https://script.google.com/macros/s/AKfycbzE92_7B0PDEJIxwGodl4M03r9jybsmS-gijtrr3mamDPd3m10XpBf_CuWgsHn8d5Gg/exec";

/* ===== VARIABILI ===== */
let rawRows = [];
let selectedRow = null;
let selectedData = null;
let listVisible = false;
let selectedKey = null;

const searchBox   = document.getElementById('searchBox');
const tbody       = document.getElementById('tbody');
const toolsCard   = document.getElementById('toolsCard');
const tableCard   = document.getElementById('tableCard');
const confirmCard = document.getElementById('confirmCard');
const confirmBtn  = document.getElementById('confirmBtn');
const countChecked= document.getElementById('countChecked');
const countTotal  = document.getElementById('countTotal');
const popupConfirm= document.getElementById('popupConfirm');
const exportCard  = document.getElementById('exportCard');
const showListBtn = document.getElementById('showListBtn');
const reportBtn   = document.getElementById('reportBtn');
const registerNewBtn = document.getElementById('registerNewBtn');

/* ===== CARICA LISTA DA SHEET (GET) ===== */
async function caricaLista(){
  try{
    const res = await fetch(sheetURL);
    const data = await res.json();
    rawRows = data;
    renderTable();
    toolsCard.classList.remove('hidden');
    exportCard.classList.remove('hidden');
  }catch(err){
    console.error("Errore caricamento:", err);
  }
}

/* ===== CONTATORI (totale / confermati) ===== */
function aggiornaContatori(){
  const total = rawRows.length;

  // Considero "confermato" qualsiasi valore NON vuoto nella colonna Confermato
  const checked = rawRows.filter(r => {
    const v = (r.confermato || "").toString().trim();
    return v !== "";
  }).length;

  countTotal.textContent = total;
  countChecked.textContent = checked;
}

/* ===== RENDER TABELLA ===== */
function renderTable(){
  tbody.innerHTML = "";
  confirmCard.classList.add('hidden');
  selectedRow = null;
  selectedData = null;

  let q = searchBox.value.trim().toLowerCase();
  let rows = rawRows;

  // se lista non visibile e ricerca vuota â†’ non mostra nulla
  if(!listVisible && q === ""){
    tableCard.classList.add('hidden');
    aggiornaContatori();
    return;
  }

  // filtro se c'Ã¨ testo nel campo
  if(q !== ""){
    rows = rawRows.filter(r=>{
      return String(r.nome ?? '').toLowerCase().includes(q) ||
             String(r.azienda ?? '').toLowerCase().includes(q) ||
             String(r.posto ?? '').toLowerCase().includes(q);
    });
  }

  if(rows.length > 0){
    tableCard.classList.remove('hidden');
  } else {
    tableCard.classList.add('hidden');
  }

  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.nome || ''}</td><td>${r.azienda || ''}</td><td>${r.posto || ''}</td>`;

    const giaConfermato = !!(r.confermato && String(r.confermato).trim() !== "");
    if(giaConfermato){
      tr.classList.add('confirmed');
      tr.style.pointerEvents = 'none';
    }

    const key = (r.nome || '') + '|' + (r.azienda || '') + '|' + (r.posto || '');

    tr.addEventListener('click', () => {
      if (giaConfermato) return;

      // toggle selezione
      if (tr.classList.contains('selected')) {
        tr.classList.remove('selected');
        selectedRow = null;
        selectedData = null;
        selectedKey = null;
        confirmCard.classList.add('hidden');
        return;
      }

      if (selectedRow) {
        selectedRow.classList.remove('selected');
      }

      tr.classList.add('selected');
      selectedRow = tr;
      selectedData = r;
      selectedKey = key;
      confirmCard.classList.remove('hidden');
    });

    if (selectedKey && key === selectedKey) {
      tr.classList.add('selected');
      selectedRow = tr;
      selectedData = r;
      confirmCard.classList.remove('hidden');
    }

    tbody.appendChild(tr);
  });

  aggiornaContatori();
}

/* ===== INVIO DATI A APPS SCRIPT (POST) ===== */
/* ===== INVIO DATI A APPS SCRIPT (POST) ===== */
/* ===== INVIO DATI A APPS SCRIPT (POST) ===== */
/* ===== INVIO DATI A APPS SCRIPT (POST) ===== */
async function confermaOspite(dati){

  // Mostro subito il popup
  popupConfirm.textContent = "Ospite accreditato";
  popupConfirm.style.display = 'block';

  // Durata unica per popup + sparizione lista
  const durata = 300;

  try{
    const res = await fetch(sheetURL, {
      method: 'POST',
      body: JSON.stringify(dati)
    });

    if (!res.ok) {
      popupConfirm.style.display = 'none';
      alert("Errore dal server (" + res.status + ")");
      return;
    }

    // â± RESET INTERFACCIA E FINE POPUP â†’ tutto sincronizzato qui
    setTimeout(() => {

        // ðŸ”¥ RESET INTERFACCIA
        searchBox.value = "";
        listVisible = false;
        selectedRow = null;
        selectedData = null;
        selectedKey = null;
        confirmCard.classList.add('hidden');

        // ðŸ”¥ Nasconde la lista
        renderTable();

        // ðŸ”¥ Nasconde il popup nello stesso identico momento
        popupConfirm.style.display = 'none';

        // ðŸ”„ Ricarica dati e contatori
        caricaLista();

    }, durata);

  }catch(err){
    popupConfirm.style.display = 'none';
    alert("Errore di rete o connessione.");
  }
}


/* ===== CONFERMA OSPITE GIÃ€ IN LISTA (CLICK SU CONFERMA) ===== */
confirmBtn.addEventListener('click', async ()=>{
  if(!selectedData) return;
  await confermaOspite(selectedData);
});

/* ===== CAMBIO TESTO NELLA RICERCA ===== */
searchBox.addEventListener('input', () => {
  renderTable();
});

/* ===== MOSTRA / NASCONDI LISTA COMPLETA ===== */
showListBtn.addEventListener('click', () => {
  listVisible = !listVisible;
  if(listVisible) searchBox.value = "";
  renderTable();
});

/* ===== REPORT EXCEL COMPLETO ===== */
reportBtn.addEventListener('click', () => {
  const ws = XLSX.utils.json_to_sheet(rawRows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Report');
  XLSX.writeFile(wb,'report_completo.xlsx');
});

/* ===== NUOVO OSPITE DA CAMPO DI RICERCA ===== */
async function aggiungiNuovoOspiteDaSearch(){
  const nome = (searchBox.value || "").trim();

  if(!nome){
    alert("Scrivi nome e cognome dell'ospite nel campo di ricerca");
    searchBox.focus();
    return;
  }

  const datiNuovo = {
    azione: "aggiungi",
    nome: nome,
    azienda: "",
    posto: "",
    confermato: "SI"
  };

  await confermaOspite(datiNuovo);

  searchBox.value = "";
  await caricaLista();

  alert("Ospite registrato e accreditato.");
}

/* ===== CLICK SU "REGISTRA NUOVO OSPITE" ===== */
registerNewBtn.addEventListener('click', async ()=>{
  registerNewBtn.disabled = true;
  const oldText = registerNewBtn.textContent;
  registerNewBtn.textContent = "Registrazione in corso...";

  try{
    await aggiungiNuovoOspiteDaSearch();
  }catch(err){
    console.error("Errore registrazione nuovo ospite:", err);
    alert("Si Ã¨ verificato un errore nella registrazione. Riprova.");
  }finally{
    registerNewBtn.disabled = false;
    registerNewBtn.textContent = oldText;
  }
});

/* ===== AVVIO ===== */
caricaLista();
setInterval(caricaLista, 5000); // aggiorna ogni 5s
  </script>
</body>
</html>
